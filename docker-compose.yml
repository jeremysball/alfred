services:
  tailscale:
    image: tailscale/tailscale:latest
    hostname: alfred
    environment:
      TS_STATE_DIR: /var/lib/tailscale
      TS_USERSPACE: false
      # TS_SERVE_CONFIG: /var/lib/tailscale/config/serve.json
    volumes:
      - ./volumes/tailscale:/var/lib/tailscale
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    restart: unless-stopped
    networks:
      - alfred_network
  alfred:
    build:
      context: .
      dockerfile: Dockerfile
    image: local/pi-coding-agent:latest
    
    tty: true
    stdin_open: true

    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GIT_AUTHOR_NAME=${GIT_NAME}
      - GIT_AUTHOR_EMAIL=${GIT_EMAIL}
      - GIT_COMMITTER_NAME=${GIT_NAME}
      - GIT_COMMITTER_EMAIL=${GIT_EMAIL}

      # GPG config
      - GIT_CONFIG_COUNT=2
      - GIT_CONFIG_KEY_0=user.signingkey
      - GIT_CONFIG_VALUE_0=${GIT_GPG_KEY}
      - GIT_CONFIG_KEY_1=commit.gpgsign
      - GIT_CONFIG_VALUE_1=${GIT_GPG_SIGN:-false}
    env_file:
      - .env

    volumes:
      - workspace:/workspace
      - home:/home/node/
      
    user: "${UID:-1000}:${GID:-1000}"    
    network_mode: service:tailscale
    depends_on:
      - tailscale
    restart: "no"

volumes:
  workspace:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/workspace
  home:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/home
networks:
  alfred_network:
    driver: bridge
